---
layout: default
title: Bible Viewer
permalink: /tools-games/tools/bible-viewer/
---

<style>
  :root {
    --bv-bg: #0f172a;
    --bv-bg-alt: #020617;
    --bv-panel: #020617;
    --bv-border: #1e293b;
    --bv-accent: #facc15;
    --bv-text: #e5e7eb;
    --bv-text-muted: #9ca3af;
    --bv-radius-lg: 20px;
    --bv-radius-md: 12px;
    --bv-shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
    --bv-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: var(--bv-font);
    background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
    color: var(--bv-text);
  }

  main.bv-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 16px 40px;
  }

  .bv-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
  }

  .bv-title-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }

  .bv-title {
    font-size: 1.75rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .bv-pill {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(250, 204, 21, 0.4);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--bv-accent);
    background: rgba(0, 0, 0, 0.5);
  }

  .bv-subtitle {
    font-size: 0.95rem;
    color: var(--bv-text-muted);
    max-width: 640px;
  }

  .bv-shell {
    display: grid;
    grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1.1fr);
    gap: 18px;
  }

  @media (max-width: 900px) {
    .bv-shell {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .bv-panel-main {
    background: radial-gradient(circle at top left, #111827 0, #020617 55%);
    border-radius: 26px;
    border: 1px solid rgba(148, 163, 184, 0.28);
    box-shadow: var(--bv-shadow-soft);
    padding: 16px 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: relative;
    overflow: hidden;
  }

  .bv-panel-main::before {
    content: "";
    position: absolute;
    inset: -25%;
    background:
      radial-gradient(circle at 0% 0%, rgba(250, 204, 21, 0.17) 0, transparent 55%),
      radial-gradient(circle at 100% 0%, rgba(148, 163, 184, 0.16) 0, transparent 55%);
    opacity: 0.8;
    pointer-events: none;
    mix-blend-mode: screen;
  }

  .bv-panel-main-inner {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .bv-controls-top {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
    justify-content: space-between;
  }

  .bv-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 10px;
    align-items: flex-end;
  }

  .bv-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 120px;
  }

  .bv-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--bv-text-muted);
  }

  select,
  input[type="number"],
  input[type="text"] {
    border-radius: var(--bv-radius-md);
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: rgba(15, 23, 42, 0.9);
    color: var(--bv-text);
    padding: 7px 10px;
    font-size: 0.9rem;
    outline: none;
    min-height: 34px;
  }

  select:focus,
  input:focus {
    border-color: var(--bv-accent);
    box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.7);
  }

  .bv-inline-label {
    font-size: 0.8rem;
    color: var(--bv-text-muted);
    min-height: 1.1em;
  }

  .bv-button,
  .bv-button-ghost {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border-radius: 999px;
    padding: 7px 14px;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    border: none;
    cursor: pointer;
    white-space: nowrap;
  }

  .bv-button {
    background: linear-gradient(135deg, #facc15, #f97316);
    color: #111827;
    font-weight: 600;
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 0.55),
      0 16px 30px rgba(15, 23, 42, 0.9);
  }

  .bv-button:hover {
    filter: brightness(1.02);
    transform: translateY(-0.5px);
  }

  .bv-button:active {
    transform: translateY(0.5px);
    box-shadow:
      0 0 0 1px rgba(15, 23, 42, 0.55),
      0 10px 18px rgba(15, 23, 42, 0.9);
  }

  .bv-button-ghost {
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(148, 163, 184, 0.6);
    color: var(--bv-text-muted);
  }

  .bv-button-ghost:hover {
    background: rgba(15, 23, 42, 0.95);
    color: var(--bv-text);
  }

  .bv-nav-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .bv-reference-form {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    flex-wrap: wrap;
  }

  .bv-reference-input {
    min-width: 160px;
  }

  .bv-status-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    align-items: center;
    font-size: 0.78rem;
    color: var(--bv-text-muted);
    margin-top: 2px;
  }

  .bv-status-badge {
    padding: 4px 9px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: rgba(15, 23, 42, 0.85);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .bv-status-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.8);
  }

  .bv-status-dot.bv-status-ok {
    background: #22c55e;
  }

  .bv-status-dot.bv-status-loading {
    background: #facc15;
  }

  .bv-status-dot.bv-status-error {
    background: #ef4444;
  }

  .bv-text-shell {
    border-radius: 20px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.18) 0, transparent 50%),
      linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
    padding: 12px 12px 16px;
    max-height: calc(100vh - 260px);
    overflow: auto;
    position: relative;
  }

  @media (max-width: 900px) {
    .bv-text-shell {
      max-height: none;
    }
  }

  .bv-text-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 8px;
  }

  .bv-text-ref {
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--bv-text-muted);
  }

  .bv-text-translation {
    font-size: 0.85rem;
    color: var(--bv-text-muted);
  }

  .bv-text {
    font-size: 0.98rem;
    line-height: 1.6;
  }

  .bv-verse {
    margin-bottom: 4px;
    padding: 4px 4px;
    border-radius: 10px;
    transition: background 0.12s ease, box-shadow 0.12s ease;
    position: relative;
  }

  .bv-verse:hover {
    background: rgba(15, 23, 42, 0.95);
    box-shadow: 0 6px 12px rgba(15, 23, 42, 0.9);
  }

  .bv-verse-num {
    font-size: 0.7rem;
    vertical-align: top;
    margin-right: 6px;
    color: var(--bv-accent);
    opacity: 0.85;
  }

  .bv-verse-text {
    font-size: 0.98rem;
  }

  .bv-text-empty {
    font-size: 0.9rem;
    color: var(--bv-text-muted);
    text-align: center;
    padding: 24px 8px 18px;
  }

  .bv-sidepanel {
    border-radius: 22px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: linear-gradient(to bottom, #020617, #020617);
    padding: 14px 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
    position: relative;
    overflow: hidden;
  }

  .bv-sidepanel::before {
    content: "";
    position: absolute;
    inset: -30%;
    background:
      radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.15) 0, transparent 50%),
      radial-gradient(circle at 100% 0, rgba(55, 65, 81, 0.25) 0, transparent 55%);
    opacity: 0.8;
    mix-blend-mode: screen;
    pointer-events: none;
  }

  .bv-sidepanel-inner {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .bv-side-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .bv-side-title {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--bv-text-muted);
  }

  .bv-side-pill {
    font-size: 0.74rem;
    padding: 4px 9px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(15, 23, 42, 0.85);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .bv-side-section {
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(15, 23, 42, 0.94);
    padding: 10px 10px 10px;
    font-size: 0.85rem;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .bv-side-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .bv-side-section-title {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--bv-text-muted);
  }

  .bv-link {
    color: var(--bv-accent);
    text-decoration: none;
    font-size: 0.85rem;
  }

  .bv-link:hover {
    text-decoration: underline;
  }

  .bv-side-kv {
    display: flex;
    justify-content: space-between;
    gap: 6px;
  }

  .bv-side-kv-label {
    color: var(--bv-text-muted);
    font-size: 0.8rem;
  }

  .bv-side-kv-value {
    font-size: 0.8rem;
    text-align: right;
  }

  .bv-side-note {
    font-size: 0.8rem;
    color: var(--bv-text-muted);
  }

  .bv-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 2px;
  }

  .bv-tag {
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 0.75rem;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: rgba(15, 23, 42, 0.9);
    color: var(--bv-text-muted);
  }

  .bv-footer-note {
    font-size: 0.78rem;
    color: var(--bv-text-muted);
    text-align: right;
    margin-top: 8px;
  }
</style>

<main class="bv-page" id="bible-viewer-page">
  <header class="bv-header">
    <div class="bv-title-row">
      <h1 class="bv-title">Bible Viewer</h1>
      <span class="bv-pill">Study Tool</span>
    </div>
    <p class="bv-subtitle">
      Choose a language, select a translation, then pick a book and chapter or jump to a reference
      (for example: <code>John 3:16</code>). Text is loaded from the local SHK data files.
    </p>
  </header>

  <section class="bv-shell" aria-label="Bible Viewer">
    <!-- MAIN PANEL -->
    <section class="bv-panel-main" aria-label="Bible text panel">
      <div class="bv-panel-main-inner">
        <!-- Top controls: language, translation, book, chapter -->
        <div class="bv-controls-top">
          <div class="bv-group" aria-label="Passage selection">
            <div class="bv-field">
              <label class="bv-label" for="bv-language-select">Language</label>
              <select id="bv-language-select"></select>
            </div>

            <div class="bv-field">
              <label class="bv-label" for="bv-translation-select">Translation</label>
              <select id="bv-translation-select"></select>
              <div class="bv-inline-label" id="bv-translation-inline"></div>
            </div>

            <div class="bv-field">
              <label class="bv-label" for="bv-book-select">Book</label>
              <select id="bv-book-select"></select>
            </div>

            <div class="bv-field">
              <label class="bv-label" for="bv-chapter-input">Chapter</label>
              <input
                id="bv-chapter-input"
                type="number"
                min="1"
                step="1"
                value="1"
                inputmode="numeric"
              />
            </div>

            <button type="button" class="bv-button" id="bv-load-button">
              Load Passage
            </button>
          </div>

          <div class="bv-group" style="justify-content: flex-end;">
            <div class="bv-nav-buttons">
              <button type="button" class="bv-button-ghost" id="bv-prev-chapter">
                ← Prev
              </button>
              <button type="button" class="bv-button-ghost" id="bv-next-chapter">
                Next →
              </button>
            </div>
          </div>
        </div>

        <!-- Reference jump row -->
        <div class="bv-controls-top" style="margin-top: 4px;">
          <form class="bv-reference-form" id="bv-reference-form" autocomplete="off">
            <div class="bv-field bv-reference-input">
              <label class="bv-label" for="bv-reference-input">Jump to reference</label>
              <input
                id="bv-reference-input"
                type="text"
                placeholder="e.g., John 3:16 or 1 Ch 1"
                spellcheck="false"
              />
            </div>
            <button type="submit" class="bv-button-ghost">
              Go
            </button>
          </form>
        </div>

        <!-- Status row -->
        <div class="bv-status-row" aria-live="polite">
          <div>
            <span id="bv-current-ref-label">No passage loaded yet.</span>
          </div>
          <div>
            <span class="bv-status-badge">
              <span class="bv-status-dot" id="bv-status-dot"></span>
              <span id="bv-status-text">Idle</span>
            </span>
          </div>
        </div>

        <!-- Text output -->
        <div class="bv-text-shell" id="bv-text-shell">
          <div class="bv-text-header">
            <div class="bv-text-ref" id="bv-heading-ref"></div>
            <div class="bv-text-translation" id="bv-heading-translation"></div>
          </div>
          <div class="bv-text" id="bv-text">
            <div class="bv-text-empty">
              Select a translation and passage, then choose <strong>Load Passage</strong> to display the text.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <aside class="bv-sidepanel" aria-label="Passage and translation details">
      <div class="bv-sidepanel-inner">
        <div class="bv-side-header">
          <div class="bv-side-title">Translation &amp; Passage</div>
          <div class="bv-side-pill">
            <span style="width: 6px; height: 6px; border-radius: 999px; background: var(--bv-accent);"></span>
            <span id="bv-side-pill-label">Ready</span>
          </div>
        </div>

        <!-- Translation Info -->
        <section class="bv-side-section" aria-label="Translation info">
          <div class="bv-side-section-header">
            <div class="bv-side-section-title">Translation</div>
            <a
              class="bv-link"
              id="bv-translation-link"
              href="{{ site.baseurl }}/literature/bible/translations/en/kjv/"
            >
              Full details
            </a>
          </div>
          <div class="bv-side-kv">
            <span class="bv-side-kv-label">Name</span>
            <span class="bv-side-kv-value" id="bv-side-translation-name">–</span>
          </div>
          <div class="bv-side-kv">
            <span class="bv-side-kv-label">Code</span>
            <span class="bv-side-kv-value" id="bv-side-translation-code">–</span>
          </div>
          <p class="bv-side-note" id="bv-side-translation-note">
            Translation metadata is loaded from the Bible Viewer index and each translation’s manifest.
          </p>
        </section>

        <!-- Passage Summary -->
        <section class="bv-side-section" aria-label="Passage summary">
          <div class="bv-side-section-header">
            <div class="bv-side-section-title">Current passage</div>
          </div>
          <div class="bv-side-kv">
            <span class="bv-side-kv-label">Reference</span>
            <span class="bv-side-kv-value" id="bv-side-passage-ref">–</span>
          </div>
          <div class="bv-side-kv">
            <span class="bv-side-kv-label">Verses</span>
            <span class="bv-side-kv-value" id="bv-side-passage-verse-count">–</span>
          </div>
          <p class="bv-side-note">
            This summary updates when a chapter is loaded. We can later add themes, links to other tools, etc.
          </p>
        </section>

        <!-- Viewer Modes -->
        <section class="bv-side-section" aria-label="Viewer modes">
          <div class="bv-side-section-header">
            <div class="bv-side-section-title">Viewer modes</div>
          </div>
          <div class="bv-tags">
            <span class="bv-tag">Single chapter</span>
            <span class="bv-tag">Reference jump</span>
            <span class="bv-tag">Local JSON data</span>
          </div>
          <p class="bv-side-note">
            Later we can add parallel translations, part-of-speech highlighting, and links to SHK study tools here.
          </p>
        </section>

        <div class="bv-footer-note">
          Data index: <code>/data/v1/tools/bible-viewer/index.json</code>
        </div>
      </div>
    </aside>
  </section>
</main>

<script>
  (function () {
    "use strict";

    // Respect Jekyll baseurl (for GitHub Pages /SHK)
    const BASEURL = "{{ site.baseurl | default: '' }}";
    const BV_INDEX_URL = BASEURL + "/data/v1/tools/bible-viewer/index.json";

    let BV_CONFIG = null;
    const BV_LANG_BY_CODE = new Map();
    const BV_TRANSLATION_BY_CODE = new Map();

    const bvState = {
      languageCode: null,
      translationCode: null,
      bookCode: "JHN",
      chapter: 1
    };

    const BOOKS = [
      { code: "GEN", name: "Genesis" },
      { code: "EXO", name: "Exodus" },
      { code: "LEV", name: "Leviticus" },
      { code: "NUM", name: "Numbers" },
      { code: "DEU", name: "Deuteronomy" },
      { code: "JOS", name: "Joshua" },
      { code: "JDG", name: "Judges" },
      { code: "RUT", name: "Ruth" },
      { code: "1SA", name: "1 Samuel" },
      { code: "2SA", name: "2 Samuel" },
      { code: "1KI", name: "1 Kings" },
      { code: "2KI", name: "2 Kings" },
      { code: "1CH", name: "1 Chronicles" },
      { code: "2CH", name: "2 Chronicles" },
      { code: "EZR", name: "Ezra" },
      { code: "NEH", name: "Nehemiah" },
      { code: "EST", name: "Esther" },
      { code: "JOB", name: "Job" },
      { code: "PSA", name: "Psalms" },
      { code: "PRO", name: "Proverbs" },
      { code: "ECC", name: "Ecclesiastes" },
      { code: "SNG", name: "Song of Songs" },
      { code: "ISA", name: "Isaiah" },
      { code: "JER", name: "Jeremiah" },
      { code: "LAM", name: "Lamentations" },
      { code: "EZK", name: "Ezekiel" },
      { code: "DAN", name: "Daniel" },
      { code: "HOS", name: "Hosea" },
      { code: "JOL", name: "Joel" },
      { code: "AMO", name: "Amos" },
      { code: "OBA", name: "Obadiah" },
      { code: "JON", name: "Jonah" },
      { code: "MIC", name: "Micah" },
      { code: "NAM", name: "Nahum" },
      { code: "HAB", name: "Habakkuk" },
      { code: "ZEP", name: "Zephaniah" },
      { code: "HAG", name: "Haggai" },
      { code: "ZEC", name: "Zechariah" },
      { code: "MAL", name: "Malachi" },
      { code: "MAT", name: "Matthew" },
      { code: "MRK", name: "Mark" },
      { code: "LUK", name: "Luke" },
      { code: "JHN", name: "John" },
      { code: "ACT", name: "Acts" },
      { code: "ROM", name: "Romans" },
      { code: "1CO", name: "1 Corinthians" },
      { code: "2CO", name: "2 Corinthians" },
      { code: "GAL", name: "Galatians" },
      { code: "EPH", name: "Ephesians" },
      { code: "PHP", name: "Philippians" },
      { code: "COL", name: "Colossians" },
      { code: "1TH", name: "1 Thessalonians" },
      { code: "2TH", name: "2 Thessalonians" },
      { code: "1TI", name: "1 Timothy" },
      { code: "2TI", name: "2 Timothy" },
      { code: "TIT", name: "Titus" },
      { code: "PHM", name: "Philemon" },
      { code: "HEB", name: "Hebrews" },
      { code: "JAS", name: "James" },
      { code: "1PE", name: "1 Peter" },
      { code: "2PE", name: "2 Peter" },
      { code: "1JN", name: "1 John" },
      { code: "2JN", name: "2 John" },
      { code: "3JN", name: "3 John" },
      { code: "JUD", name: "Jude" },
      { code: "REV", name: "Revelation" }
    ];

    const languageSelect = document.getElementById("bv-language-select");
    const translationSelect = document.getElementById("bv-translation-select");
    const translationInline = document.getElementById("bv-translation-inline");
    const bookSelect = document.getElementById("bv-book-select");
    const chapterInput = document.getElementById("bv-chapter-input");
    const loadButton = document.getElementById("bv-load-button");
    const prevButton = document.getElementById("bv-prev-chapter");
    const nextButton = document.getElementById("bv-next-chapter");
    const refForm = document.getElementById("bv-reference-form");
    const refInput = document.getElementById("bv-reference-input");

    const currentRefLabel = document.getElementById("bv-current-ref-label");
    const statusDot = document.getElementById("bv-status-dot");
    const statusText = document.getElementById("bv-status-text");

    const textShell = document.getElementById("bv-text-shell");
    const textHeadingRef = document.getElementById("bv-heading-ref");
    const textHeadingTranslation = document.getElementById("bv-heading-translation");
    const textContainer = document.getElementById("bv-text");

    const sideTranslationLink = document.getElementById("bv-translation-link");
    const sideTranslationName = document.getElementById("bv-side-translation-name");
    const sideTranslationCode = document.getElementById("bv-side-translation-code");
    const sidePassageRef = document.getElementById("bv-side-passage-ref");
    const sideVerseCount = document.getElementById("bv-side-passage-verse-count");
    const sidePillLabel = document.getElementById("bv-side-pill-label");

    function setStatus(mode, message) {
      statusDot.classList.remove("bv-status-ok", "bv-status-loading", "bv-status-error");
      if (mode === "ok") statusDot.classList.add("bv-status-ok");
      else if (mode === "loading") statusDot.classList.add("bv-status-loading");
      else if (mode === "error") statusDot.classList.add("bv-status-error");
      statusText.textContent = message || "";
    }

    function getCurrentLanguage() {
      return BV_LANG_BY_CODE.get(bvState.languageCode) || null;
    }

    function getCurrentTranslation() {
      return BV_TRANSLATION_BY_CODE.get(bvState.translationCode) || null;
    }

    async function loadBibleViewerConfig() {
      const res = await fetch(BV_INDEX_URL, { cache: "no-store" });
      if (!res.ok) {
        throw new Error("Failed to load Bible Viewer index");
      }
      const json = await res.json();

      if (!json.languages || !Array.isArray(json.languages)) {
        throw new Error("Invalid Bible Viewer index: missing languages[]");
      }

      BV_CONFIG = json;
      BV_LANG_BY_CODE.clear();
      BV_TRANSLATION_BY_CODE.clear();

      json.languages.forEach((lang) => {
        BV_LANG_BY_CODE.set(lang.code, lang);
        (lang.translations || []).forEach((tr) => {
          BV_TRANSLATION_BY_CODE.set(tr.code, {
            ...tr,
            language_code: lang.code
          });
        });
      });

      bvState.languageCode = json.default_language || json.languages[0].code;
      const defaultLang = BV_LANG_BY_CODE.get(bvState.languageCode);
      let defaultTranslationCode = json.default_translation;

      if (
        !defaultTranslationCode ||
        !defaultLang.translations.some((t) => t.code === defaultTranslationCode)
      ) {
        defaultTranslationCode = defaultLang.translations[0].code;
      }
      bvState.translationCode = defaultTranslationCode;
    }

    function initLanguageSelect() {
      languageSelect.innerHTML = "";
      BV_CONFIG.languages.forEach((lang) => {
        const opt = document.createElement("option");
        opt.value = lang.code;
        opt.textContent = lang.label || lang.code.toUpperCase();
        languageSelect.appendChild(opt);
      });
      languageSelect.value = bvState.languageCode;

      languageSelect.addEventListener("change", () => {
        bvState.languageCode = languageSelect.value;
        const lang = getCurrentLanguage();
        const firstTr = lang?.translations?.[0];
        if (firstTr) {
          bvState.translationCode = firstTr.code;
        }
        refreshTranslationSelect();
        updateTranslationUI();
      });
    }

    function refreshTranslationSelect() {
      const lang = getCurrentLanguage();
      translationSelect.innerHTML = "";

      (lang?.translations || []).forEach((tr) => {
        const opt = document.createElement("option");
        opt.value = tr.code;
        opt.textContent = tr.short_label || tr.title || tr.code.toUpperCase();
        translationSelect.appendChild(opt);
      });

      translationSelect.value = bvState.translationCode;
    }

    function initTranslationSelect() {
      refreshTranslationSelect();
      translationSelect.addEventListener("change", () => {
        bvState.translationCode = translationSelect.value;
        updateTranslationUI();
      });
    }

    function initBookSelect() {
      bookSelect.innerHTML = "";
      BOOKS.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.code;
        opt.textContent = b.name;
        bookSelect.appendChild(opt);
      });
      bookSelect.value = bvState.bookCode;
      bookSelect.addEventListener("change", () => {
        bvState.bookCode = bookSelect.value;
      });
    }

    function initChapterInput() {
      chapterInput.value = String(bvState.chapter);
      chapterInput.addEventListener("change", () => {
        const val = Number(chapterInput.value);
        bvState.chapter = isNaN(val) || val < 1 ? 1 : val;
        chapterInput.value = String(bvState.chapter);
      });
    }

    function updateTranslationUI() {
      const tr = getCurrentTranslation();
      const lang = getCurrentLanguage();
      if (!tr) return;

      translationInline.textContent =
        (lang?.label || tr.language_label || tr.language_code || "").toString() +
        (tr.short_label ? " • " + tr.short_label.toUpperCase() : "");

      sideTranslationName.textContent = tr.title || tr.short_label || tr.code.toUpperCase();
      sideTranslationCode.textContent =
        tr.code.toUpperCase() + (tr.language_code ? " (" + tr.language_code + ")" : "");

      if (tr.translation_page) {
        sideTranslationLink.href = BASEURL + tr.translation_page;
      }
    }

    function getCurrentBookName() {
      const b = BOOKS.find((bk) => bk.code === bvState.bookCode);
      return b ? b.name : bvState.bookCode;
    }

    function updateHeading(refString) {
      const tr = getCurrentTranslation();
      textHeadingRef.textContent = refString || "";
      textHeadingTranslation.textContent = tr
        ? tr.title || tr.short_label || tr.code.toUpperCase()
        : "";
      currentRefLabel.textContent = refString
        ? "Loaded: " + refString + (tr ? " (" + tr.code.toUpperCase() + ")" : "")
        : "No passage loaded yet.";
      sidePassageRef.textContent = refString || "–";
    }

    function clearText(message) {
      textContainer.innerHTML = "";
      const div = document.createElement("div");
      div.className = "bv-text-empty";
      div.textContent = message || "No text available.";
      textContainer.appendChild(div);
    }

    function renderChapter(data) {
      let verses = [];

      if (Array.isArray(data)) {
        verses = data;
      } else if (Array.isArray(data.verses)) {
        verses = data.verses;
      } else if (data && typeof data === "object") {
        const keys = Object.keys(data)
          .filter((k) => /^\d+$/.test(k))
          .sort((a, b) => Number(a) - Number(b));
        if (keys.length) {
          verses = keys.map((k) => ({ verse: Number(k), text: data[k] }));
        }
      }

      if (!verses || !verses.length) {
        clearText(
          "Chapter data loaded, but no verses were detected. The JSON schema may need a custom renderer."
        );
        sideVerseCount.textContent = "0";
        return;
      }

      textContainer.innerHTML = "";
      verses.forEach((v, index) => {
        const num = v.verse || v.v || v.n || index + 1;
        const text =
          v.text || v.t || v.content || (typeof v === "string" ? v : JSON.stringify(v));

        const wrapper = document.createElement("div");
        wrapper.className = "bv-verse";
        wrapper.dataset.verse = String(num);

        const numSpan = document.createElement("span");
        numSpan.className = "bv-verse-num";
        numSpan.textContent = num;

        const textSpan = document.createElement("span");
        textSpan.className = "bv-verse-text";
        textSpan.textContent = " " + text;

        wrapper.appendChild(numSpan);
        wrapper.appendChild(textSpan);
        textContainer.appendChild(wrapper);
      });

      sideVerseCount.textContent = String(verses.length);
    }

    function buildChapterUrl(bookCode, chapterNumber) {
      const tr = getCurrentTranslation();
      if (!tr) throw new Error("No translation selected");

      const chapStr = String(chapterNumber).padStart(3, "0");
      let root = tr.path || "";
      root = root.replace(/\/+$/, "");
      const chaptersDir = (tr.chapters_dir || "chapters").replace(/^\/+|\/+$/g, "");
      return BASEURL + root + "/" + chaptersDir + "/" + bookCode + "/" + chapStr + ".json";
    }

    async function loadCurrentChapter() {
      const tr = getCurrentTranslation();
      if (!tr) {
        setStatus("error", "No translation selected.");
        return;
      }

      if (!bvState.bookCode || !bvState.chapter || bvState.chapter < 1) {
        setStatus("error", "Please choose a valid book and chapter.");
        return;
      }

      const refString = getCurrentBookName() + " " + bvState.chapter;
      setStatus("loading", "Loading " + refString + "…");
      sidePillLabel.textContent = "Loading";
      textShell.scrollTop = 0;

      try {
        const url = buildChapterUrl(bvState.bookCode, bvState.chapter);
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) {
          throw new Error("HTTP " + response.status + " when fetching " + url);
        }
        const data = await response.json();
        renderChapter(data);
        updateHeading(refString);
        setStatus("ok", "Loaded " + refString);
        sidePillLabel.textContent = "Loaded";
      } catch (err) {
        console.error(err);
        clearText(
          "Unable to load " + refString + ". Check that the JSON file exists and its schema."
        );
        updateHeading("");
        setStatus("error", "Error loading passage (see console).");
        sidePillLabel.textContent = "Error";
      }
    }

    function parseReferenceString(refStr) {
      if (!refStr) return null;
      const raw = refStr.trim().replace(/\s+/g, " ");

      const match = raw.match(/(.+?)\s+(\d+)(?::(\d+))?$/);
      if (!match) return null;

      let bookPart = match[1].trim();
      const chapter = Number(match[2]);

      bookPart = bookPart
        .replace(/\./g, "")
        .replace(/\s+/g, " ")
        .trim();

      const leadingDigitMatch = bookPart.match(/^(\d)\s*(.+)$/);
      let normalizedBook = bookPart;
      if (leadingDigitMatch) {
        normalizedBook = leadingDigitMatch[1] + " " + leadingDigitMatch[2];
      }

      const normalized = normalizedBook.toLowerCase();

      const candidates = BOOKS.filter((b) => {
        const name = b.name.toLowerCase();
        if (name === normalized) return true;
        if (normalized === b.code.toLowerCase()) return true;
        if (normalized === "jn" && b.code === "JHN") return true;
        if (normalized === "jhn" && b.code === "JHN") return true;
        if (normalized === "ps" && b.code === "PSA") return true;
        if (normalized === "psa" && b.code === "PSA") return true;
        if (normalized === "1 ch" && b.code === "1CH") return true;
        if (normalized === "2 ch" && b.code === "2CH") return true;
        return false;
      });

      if (!candidates.length) return null;

      return {
        bookCode: candidates[0].code,
        chapter: chapter
      };
    }

    function shiftChapter(delta) {
      let chapter = Number(bvState.chapter) || 1;
      chapter += delta;
      if (chapter < 1) chapter = 1;
      bvState.chapter = chapter;
      chapterInput.value = String(chapter);
      loadCurrentChapter();
    }

    function attachHandlers() {
      initLanguageSelect();
      initTranslationSelect();
      initBookSelect();
      initChapterInput();
      updateTranslationUI();

      loadButton.addEventListener("click", () => {
        const val = Number(chapterInput.value);
        bvState.chapter = isNaN(val) || val < 1 ? 1 : val;
        chapterInput.value = String(bvState.chapter);
        loadCurrentChapter();
      });

      prevButton.addEventListener("click", () => shiftChapter(-1));
      nextButton.addEventListener("click", () => shiftChapter(1));

      refForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const value = refInput.value;
        const parsed = parseReferenceString(value);
        if (!parsed) {
          setStatus("error", "Could not parse that reference.");
          return;
        }
        bvState.bookCode = parsed.bookCode;
        bvState.chapter = parsed.chapter;
        bookSelect.value = parsed.bookCode;
        chapterInput.value = String(parsed.chapter);
        loadCurrentChapter();
      });
    }

    async function init() {
      try {
        setStatus("loading", "Loading Bible Viewer index…");
        await loadBibleViewerConfig();
        attachHandlers();
        setStatus("ok", "Ready");
        sidePillLabel.textContent = "Ready";
      } catch (err) {
        console.error(err);
        setStatus("error", "Failed to load Bible Viewer index.");
        sidePillLabel.textContent = "Error";
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  })();
</script>
